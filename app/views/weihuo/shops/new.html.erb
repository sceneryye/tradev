<% if @exiting_shop.present? %>
<div class="return">
  <h4>您已经拥有店铺，点击<a href="/weihuo/shops/<%= @exiting_shop.first.shop_id %>">这里</a>前往您的店铺</h4>
</div>
<% else %>
<div class="container">
  <div class="col-xs-12">
    <h3 class="center">申请尾货良品店铺</h3>
    <form action="/weihuo/shops" class="build-store" method="post">
      <input type="hidden" name="member_id" value="<%= current_account.account_id %>" />
      <div class="row">

        <div class="row">
          <div class="col-xs-10 col-xs-offset-1">
            <select name="city_name" class="city-name" data-name=''>
              <option value=''>请选择您的城市</option>
              <%= @cities.each do |city| %>
              <option value="<%= city.name %>"><%= city.name %></option>
              <% end %>
            </select>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xs-10 col-xs-offset-1">
          <select name="organisation_name" class="organisation-name" data-name=''>
            <option value=''>请选择您的网点</option>
            <%= @organisations.each do |o| %>
            <option value="<%= o.name %>"><%= o.name %></option>
            <% end %>
          </select>
        </div>
      </div>
    </form>

    <div class="row">
      <div class="col-xs-10 col-xs-offset-1">
        <select name="employee_name" class="employee-name">
          <option value=''>请选择您的姓名</option>
          <% if @employees.present? %>
          <%= @employees.each do |employee| %>
          <option value=<%= employee.name %>><%= employee.name %></option>
          <% end %>
        </select>
        <% end %>
      </div>
    </div>

    <div class="row">
      <div class="col-xs-10 col-xs-offset-1">
        <input name = "employee_mobile" type="text" data-mobile="<%= Ecstore::WeihuoEmployee.where(:name => params[:employee_name]).first.mobile if params[:employee_name].present? %>" placeholder="请输入您的手机号">
      </div>
    </div>

    <div class='col-xs-10 col-xs-offset-1'>
      <input name="province" placeholder="请输入省份" class="province" />
      <input name ="city" placeholder="请输入城市" class="city" />
      <input name ="address" placeholder="请输入详细地址" class="address" />
    </div>

    <div class="col-xs-10 col-xs-offset-1">
      <div class="errmsg"></div>
    </div>
    <div class="row">
      <div class="col-xs-10 col-xs-offset-1">
        <input type="button" class="btn btn-success pull-right" value="提交申请">
      </div>
    </form>
  </div>
</div>
<% end %>

<script type="text/javascript" src="/assets/area_seletor.js.erb"></script>
<script type="text/javascript">
  $(document).ready(function(){
    var url = '/weihuo/shops/new';
    var param = location.search.replace('?', '');
    $('.city-name').on('change', function(){
      var city_name = $(this).val();
      if(location.search) {
        location.href = location.pathname + location.search.split('&')[0] + '&city_name=' + encodeURI(city_name);
      }
      else {
        location.href += '?city_name=' + encodeURI(city_name);
      }
    });
    if(param == "") {
      var params = [];
    }
    else {
      var params = param.split('&');
      var name = decodeURI(params[1].split('=')[1])
      $('.city-name').val(name);
    }

    $('.organisation-name').on('change', function(){
      var organisation_name = $(this).val();
      if(location.search) {
        location.href = location.pathname + location.search.split('&')[0] + '&' + location.search.split('&')[1] + '&organisation_name=' + encodeURI(organisation_name);
      }
      else {
        location.href += '?organisation_name=' + encodeURI(organisation_name);
      }
    });
    if(param == "") {
      var params = [];
    }
    else {
      var params = param.split('&');
      var name = decodeURI(params[2].split('=')[1])
      $('.organisation-name').val(name);
    }

    $('.employee-name').on('change', function(){
      var employee_name = $(this).val();
       // if(params.length == 1) {
         // location.href += '&employee_name=' + encodeURI(employee_name);
       // }
        //else {
          //location.href = loc.pathname + location.search.split('&')[0] + '&employee_name=' + encodeURI(employee_name);
       // }
       location.href = location.pathname + location.search.split('&')[0] + '&' + location.search.split('&')[1] + '&' + location.search.split('&')[2] + '&employee_name=' + encodeURI(employee_name);
     });
    
    $('.employee-name').val(decodeURI(params[3].split('=')[1]));
    


    $("input[name='employee_mobile']").on('change', function(){
      var employee_mobile = $(this).attr('data-mobile');
      var mobile = $(this).val();
      if(mobile != employee_mobile) {
        $('.errmsg').text('您输入的姓名与手机号码不一致，请重新填写。');
        $(this).val('');
      }
    });

    $("input[type='button']").on('click',function(){
     if($('.organisation-name').val() == '' || $('.employee-name').val() == '' || $("input[name='employee_mobile']").val() == undefined || $("input[name='employee_mobile']").val() == '' || $('.province').val() == '' || $('.city').val() == '' || $('.address').val() == '') {
      swal({
        title: '信息不完整',
        text: '请填写完整信息',
        type: 'warning',
        showCancelButton: false,
        closeOnConfirm: true,
        animation: "slide-from-top",
        confirmButtonText: '确定',
        timer: 5000
      });
    }
    else {
      $('.build-store').submit();
    }
  });

  })
</script>

<style type="text/css">
  .return {
    width: 80%;
    margin: 0 auto;
    vertical-align: middle;
  }
  .label-new-shop {
    color: black;

  }
  .errmsg {
    color: red;
    height: 50px;
    margin-top: -35px;
    margin-bottom: 10px;
  }
  .center {
    text-align: center;
  }
  .right {
    position: relative;
  }
  .row {
    margin-bottom: 20px;
  }
  select, input {
    width: 100%;
    margin-bottom: 20px;
  }

</style>

